<!DOCTYPE html>
<html lang="it">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1.0">
        <link rel=stylesheet href="bootstrap/css/bootstrap.css">
        <link rel=stylesheet href="main_styles.css" type="text/css">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
        <script type="module" src="./js/functions.js"></script>
        <script type="module" src="./js/func2.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
        <title>Accesso</title>
    </head>
    <body class="text-center">
        <div class="grid-main-container">


            <div class="box-description">
                <img alt="Qries" src="Logoproject.png" width="300" height="300">
            </div>

            <div class="box-access"><table width="100%">
                <tr>
                    <td>
                        <h1> Accesso </h1>
                        <!--form action="" method="post" id="Bee" onsubmit="Accedi();"-->
                            <input type="text" class="form-control;text-center; border-1 rounded" name="userlog" id='userlog' placeholder="Username" style="width: 40%; text-align: center; " required autofocus>
                            <div class="mb-1"></div>
                            <input type="password" class="form-control;text-center; border-1 rounded" id="passlog" placeholder="Password"  style="width: 40%;text-align: center;" required>
                            <div class="mb-2"></div>
                            <div class="custom-control custom-switch mb-3">
                                <input type="checkbox" class="custom-control-input" id="stay">
                                <label class="custom-control-label" for="stay"> Keep me Logged In </label>
                            </div>
                            <button type="submit" class="btn btn-light" id="login"  name="submit"> Go! </button>
                        <!--/form-->
                    </td>
                </tr>
            </table></div>
            <div class="box-registration">
                <table width="100%">
                    <tr>
                        <td>
                            <h1> Registrazione </h1>
                                <h2> About you</h2>
                                <input type="text" class="border-1 rounded" id="nreg" placeholder="Name" required style="width: 40%;text-align: center; "> 
                                <div class="mb-1"></div>
                                <input type="text" class="border-1 rounded" id="creg" placeholder="Surname" required style="width: 40%;text-align: center;"> 
                                <div class="mb-1"></div>
                                <input type="number" class="border-1 rounded" value="Numero di telefono" id="numreg" placeholder="Cell" style="width: 40%;text-align: center;"> 
                                <div class="mb-1"></div>
                                <input type="email" class="form-control; border-1 rounded" name="email" id="ereg" placeholder="Email"style="width: 40%; text-align: center;" required >
                                <div class="mb-4"></div>
                                <h2>Almost there...</h2>
                                <input type="text" class="form-control; border-1 rounded" name="user" id="user" placeholder="Username" style="width: 40%; text-align: center;" required >
                                <div class="mb-1"></div>
                                <input type="password" class="form-control;text-center; border-1 rounded" name="password" id="preg" placeholder="Password" style="width: 40%;text-align: center;" required>
                                <div class="mb-1"></div>
                                <button type="submit" class="btn btn-light" id="sub" style="font-size:small;"> let's start! </button>
                        </td>
                    </tr>
                </table>
            </div>
        </div>

        <script type="module">
            // Import the functions you need from the SDKs you need
            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.3/firebase-app.js";
            import { getDatabase, set, ref, update , get, child } from "https://www.gstatic.com/firebasejs/9.6.3/firebase-database.js";
            import { getAuth, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.3/firebase-auth.js";
           // import * as func2 from "./js/func2.js";

            const firebaseConfig = {
              apiKey: "AIzaSyA0PdI6RRM_VqyxEsUYuPe0Gu_TUrbbuuQ",
              authDomain: "beeteam-2a5f7.firebaseapp.com",
              databaseURL: "https://beeteam-2a5f7-default-rtdb.firebaseio.com",
              projectId: "beeteam-2a5f7",
              storageBucket: "beeteam-2a5f7.appspot.com",
              messagingSenderId: "223479016271",
              appId: "1:223479016271:web:383e9319470cfaf4bd733a",
              measurementId: "G-04ERX78GQJ"
            };
          
            // Initialize Firebase
           export const app= initializeApp(firebaseConfig);
           export const database = getDatabase(app);
           //const auth=getAuth();

     //REGISTRATION 
            const nome=document.getElementById("nreg");
            const cognome=document.getElementById("creg");
            const numero=document.getElementById("numreg");
            const email=document.getElementById("ereg");
            const user=document.getElementById("user");
            const password=document.getElementById("preg");
            const sub=document.getElementById("sub");

            function RegisterUser(){
                const db = ref(database);

                get(child(db,"Users/"+ user.value )).then((snapshot)=>{
                    if(snapshot.exists()){
                        alert("Account already exists!");
                    }
                    else{
                        set(ref(database, "Users/"+user.value),
                        {
                            nome:nome.value,
                            cognome: cognome.value,
                            numero: numero.value,
                            user:user.value,
                            email:email.value,
                            password: encPass()
                        })
                       .then(()=>{
                           alert("User created");
                       })
                       .catch((error)=>{
                           allert("error: "+error);
                       })
                    }
                });
            }

            //ENCRYPTION

            function encPass(){
                var pass12 = CryptoJS.AES.encrypt(password.value, password.value);
                //password and key we are providing 
                return pass12.toString();
            }

            // EVENT HENDLER
            sub.addEventListener('click',RegisterUser);


            //LOGIN!

            //costant
            const userlog=document.getElementById("userlog");
            const passlog=document.getElementById("passlog");
            const login=document.getElementById("login");

            //AUTHENTICATION
            function Authentication(){
                const db2=ref(database);
                get(child(db2,"Users/"+ userlog.value )).then((snapshot)=>{
                    if(snapshot.exists()){
                        let dbpass = decPass(snapshot.val().password);
                        if(dbpass==passlog.value){
                            LoginUser(snapshot.val());
                        }
                    }
                    else{
                           allert("User doesn't exist! ");
                    }
                });
            }
            function decPass(dbpass){
                var pass12=CryptoJS.AES.decrypt(dbpass, passlog.value);
                return pass12.toString(CryptoJS.enc.Utf8);
            }

            function LoginUser(userinfo){
                let keepLog=document.getElementById("stay").checked;

                if(!keepLog){
                    sessionStorage.setItem('user', JSON.stringify(userinfo));
                    localStorage.setItem('KeepLog','no');
                    window.location="profilo.html";
                }
                else{

                    localStorage.setItem('KeepLog','yes');
                    localStorage.setItem('user', JSON.stringify(userinfo));
                    window.location="profilo.html";
                }

            }

            login.addEventListener('click',Authentication);
        
          </script>
          <!--script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/7.14.1-0/firebase.js"></script-->
            
    </body>
</html>