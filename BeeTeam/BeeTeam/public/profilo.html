	<!DOCTYPE html>
	<html lang="it">
		<head>
			<title> Profilo </title>
			<meta charset="UTF-8">

			<meta name="viewport" content="width=device-width,initial-scale=1.0">
			<link rel="stylesheet" href="bootstrap/css/bootstrap.css">
			<link rel=stylesheet href="main_styles.css" type="text/css">
			<link rel="preconnect" href="https://fonts.googleapis.com">
			<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	        <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,400;0,500;1,100;1,700&display=swap" rel="stylesheet">
			<script type="module" src="./js/functions.js"></script>
		</head>
		
	<body class="text-center" >

		<div class="grid-main-container-profile">

			<div class="box-header">
				<div class="box-header-left">
					<span style="font-weight: 800; color: #ffbf00; font-size: 2vw;">BEE</span>
					<span style="font-weight: 100; color: #ffbf00; font-size: 2vw;">TEAM</span>
				</div>
				<div class="box-header-center">
					<img alt="Qries" src="Logoproject.png" width="65" height="65">
				</div>
				<div class="box-header-right">
				<a href="bacheca.html">Bacheca</a>
				<a class="active" href="profilo.html">Profilo</a>
				</div>
			</div>

			<div class="box-main-profile">
				<div class="box-up-profile">
					<table width="100%" height="100%">
						<tr>
							<td width="30%" valign="middle"> 
								<br>
								<img name="FotoUtente" src="nofoto.jpg" width="80%" style="border-radius: 100px;" id="fotoprofilo"  >
								<input type="file" id="sourcefoto" width="100%" style="color: transparent; display: none;" accept=".jpg, .png, .jpeg">
								<br>
								<div class="row-mb-4" style="padding-bottom: 3px;">
								<button id="editbutton" class="btn btn-light btn-sm" onclick="document.getElementById('sourcefoto').click()">Edit</button>
								<button id="subedit" class="btn btn-light btn-sm" >Invia</button>
								</div>
							</td>
							<td> 
								<div class="table" width="100%" >
								<div class="row-mb-4" > 
									<span id="nprof" style="font-weight: 400;">Nome</span>  
									<span id="cprof">Cognome</span>
								</div>  
								<div class="row-mb-4" id="userprofil"> Username </div>
								<div class="row-mb-4" id="numprof">Numero di telefono</div>
								<div class="row-mb-4" id="eprof">Email</div>
								<div class="row-mb-4" style="padding-top: 5%;" id="inviamodifica">
										<button type="submit" id="editinfo" class="btn btn-light btn-sm">Edit</button>
										<button type="submit" id="logout" class="btn btn-light">Logout</button>
								</div>
								</div>
							</td>
						</tr>
				</table>
				</div>

				<div class="box-down-profile" > 
					
					<div class="box-down-left-profile" id="spazio_creati">
						<h1> Created</h1>
					</div>
					<div class="box-down-right-profile" id="spazio_aderiti">
						<h1> Subscribed </h1>
					</div>	
				</div>
			</div>

			<div class="box-footer">
                <h3>@BeeTea inc.</h3>
            </div>

		</div>
		
		<script type="module">
				import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.3/firebase-app.js";
				import { getDatabase, set, ref, update , get, child,onValue ,onChildAdded, orderByChild,limitToLast} from "https://www.gstatic.com/firebasejs/9.6.3/firebase-database.js";
				import { getAuth, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.3/firebase-auth.js";
				import { getStorage, ref as storef, uploadBytesResumable,getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.3/firebase-storage.js";
				import { collection, query, where, getDoc,addDoc,getFirestore, updateDoc,arrayUnion,doc ,setDoc, increment} from "https://www.gstatic.com/firebasejs/9.6.3/firebase-firestore.js";

			// import * as func2 from "./js/func2.js";
			   import {att,att2,att_sub,att_richiesta} from "./js/functions.js";

				const firebaseConfig = {
				apiKey: "AIzaSyA0PdI6RRM_VqyxEsUYuPe0Gu_TUrbbuuQ",
				authDomain: "beeteam-2a5f7.firebaseapp.com",
				databaseURL: "https://beeteam-2a5f7-default-rtdb.firebaseio.com",
				projectId: "beeteam-2a5f7",
				storageBucket: "beeteam-2a5f7.appspot.com",
				messagingSenderId: "223479016271",
				appId: "1:223479016271:web:383e9319470cfaf4bd733a",
				measurementId: "G-04ERX78GQJ"
				};
			
				// Initialize Firebase
			export const app= initializeApp(firebaseConfig);
			export const database = getDatabase(app);
			const fire=getFirestore(app);

			let nprof=document.getElementById("nprof");
			let cprof=document.getElementById("cprof");
			let userprof=document.getElementById("userprofil");
			let numprof=document.getElementById("numprof");
			let eprof=document.getElementById("eprof");
			let foto=document.getElementById("fotoprofilo");

			let inviamodifica=document.getElementById("inviamodifica");


			const out=document.getElementById("logout");
			const edit=document.getElementById("editbutton");
			const sub=document.getElementById("subedit");
			const info=document.getElementById("editinfo")
			var percorso=null;
			
			var storage=getStorage(app);

			var CurrentUser=null;

			function getUser(){
				let keepLog=localStorage.getItem('KeepLog');

				if(keepLog == "yes"){
					CurrentUser=JSON.parse(localStorage.getItem('user'));
				}
				else{
					CurrentUser=JSON.parse(sessionStorage.getItem('user'));
				}
			};

			function signout(){
				sessionStorage.removeItem('user');
				localStorage.removeItem('user');
				localStorage.removeItem('KeepLog');
				window.location="accesso.html";

			};

			

			function updatePhoto(){
				const f=document.getElementById("sourcefoto").files[0];
				
				const metadata = {
					contentType: 'image/'+f.type,
				};
				
				var storageRef= storef(storage, "FotoProfilo/"+ CurrentUser.user);
				var uploadTask= uploadBytesResumable(storageRef,f,metadata)
					alert("Update Succesfully");
			

				getDownloadURL(uploadTask.snapshot.ref).then((url) => {
				console.log('File available at', url);
				const xhr = new XMLHttpRequest();
				xhr.responseType = 'blob';
				xhr.onload = (event) => {
					const blob = xhr.response;
				};
				xhr.open('GET', url);
				xhr.send();
				foto.setAttribute("src",url);
				update(ref(database, "Users/"+CurrentUser.uid),{
							foto:url,
				})
				})
				.catch((error)=>{
					alert(error);
				})

			};
			
			var btnsub=null,c2=null,n2=null, num2=null;

			function getElem(id,parent,type,c,place){
				c=document.createElement("input");
				c.setAttribute("type",type);
				c.setAttribute("id",id);
				c.setAttribute("placeholder",place);
				c.setAttribute("style","background-color: transparent; weigth: 100%; border-color: transparent;");
				c.setAttribute("class","text-warning bg-dark; text-center");
				parent.innerText="";
				parent.appendChild(c);
				return c;
			}

			function editInfo(){
				n2=getElem("n2",nprof,"text",n2,CurrentUser.nome);
				c2=getElem("c2",cprof,"text",c2,CurrentUser.cognome);
				num2=getElem("num2",numprof,"number",num2,CurrentUser.numero);

				info.setAttribute("style","display:none");

				btnsub=document.createElement("button");
				btnsub.setAttribute("type","submit");
				btnsub.setAttribute("id","btnsub");
				btnsub.setAttribute("class","btn btn-light btn-sm");
				btnsub.innerHTML="Save";
				inviamodifica.appendChild(btnsub);
				alert("Modify your info");

				btnsub.addEventListener('click',saveInfo);
			}

			function saveInfo(){
				var i=0;
				btnsub.setAttribute("style","display:none");
				info.setAttribute("style","display:inline");

				var novalue=CurrentUser.nome,  cvalue=CurrentUser.cognome,  nvalue=CurrentUser.numero; 
				if(n2.value != novalue && n2.value != "") novalue=n2.value; i++;
				if(c2.value != cvalue && c2.value != "") cvalue=c2.value; i++;
				if(num2.value != nvalue && num2.value != "") nvalue=num2.value; i++;

			if(i>0){
				update(ref(database, "Users/"+ CurrentUser.uid),{
							nome:novalue,
							cognome:cvalue,
							numero:nvalue
				})
				nprof.removeChild(n2); n2=null;
				cprof.removeChild(c2); c2=null;
				numprof.removeChild(num2); num2=null;
				nprof.innerText=novalue;
				cprof.innerText=cvalue;
				numprof.innerText=nvalue;
				i=0;
				}
			else{
					alert("Nessuna modifica");
			}
			}

			out.addEventListener('click',signout);
			sub.addEventListener('click',updatePhoto);
			info.addEventListener('click',editInfo);

			let spazio_post=null;
			const date2= new Date();

			const commentsRef = query(ref(database, "Attivity"),orderByChild('data'));

            onChildAdded(commentsRef, (date) => {
                let c=null;
                let dati_utente=date.val();
				const docRef = doc(fire, "post",date.key);
				const docSnap =  getDoc(docRef).then((item) =>{
				const items=item.data();
				if(items.creator==CurrentUser.user) {
					spazio_post=document.getElementById("spazio_creati");
					if(items.sub_restanti!=0) att2(date.key, spazio_post, c ,dati_utente.type, dati_utente.member, dati_utente.description, items.sub_restanti);
					else att_richiesta(date.key, spazio_post, c ,dati_utente.type, dati_utente.member, dati_utente.description, items.sub_restanti);
				}
				else if(items.sub.includes(CurrentUser.email)){
					spazio_post=document.getElementById("spazio_aderiti");
					att_sub(date.key, spazio_post, c ,dati_utente.type, dati_utente.member, dati_utente.anonymous,dati_utente.description, dati_utente.user,items.sub_restanti );
				}
			}
            );
			});
			
			window.onload=function() {
				getUser();
				if(CurrentUser==null){
					alert("Non hai effettuato l'accesso!");
					window.location="accesso.html";

				}
				else{
					nprof.innerText= CurrentUser.nome;
					nprof.style="color: white";
					cprof.innerText= CurrentUser.cognome;
					cprof.style="color: white";
					userprof.innerText= CurrentUser.user;
					userprof.style="color: white";
					numprof.innerText= CurrentUser.numero;
					numprof.style="color: white";
					eprof.innerText= CurrentUser.email;
					eprof.style="color: white";
					//alert(CurrentUser.foto);
					foto.setAttribute("src",CurrentUser.foto);
					

				}
			}

				

				
			
		
	</script>
</body>
</html>
