	<!DOCTYPE html>
	<html lang="it">
		<head>
			<title> Profilo </title>
			<meta charset="UTF-8">

			<meta name="viewport" content="width=device-width,initial-scale=1.0">
			<link rel="stylesheet" href="bootstrap/css/bootstrap.css">
			<link rel=stylesheet href="main_styles.css" type="text/css">
			<link rel="preconnect" href="https://fonts.googleapis.com">
			<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	        <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,400;0,500;1,100;1,700&display=swap" rel="stylesheet">
			<script type="module" src="./js/functions.js"></script>
		</head>
		
	<body class="bg-profile">

		<div class="grid-main">
			<div class="box-header">
				<div class="box-header-left">
					<span style="font-weight: 800; color: #ffbf00; font-size: 2vw;">BEE</span>
					<span style="font-weight: 100; color: #ffbf00; font-size: 2vw;">TEAM</span>
				</div>
				<div class="box-header-center">
					<img class="image-logo" alt="Qries" src="Logoproject.png">
				</div>
				<div class="box-header-right">
				<a href="bacheca.html">Bacheca</a>
				<a class="active" href="profilo.html">Profilo</a>
				</div>
			</div>
	
			<div class="grid-profile">
				<div class="box-main-profile">
					<div class="box-up-profile">
						<div class="row">
							<div class="col-sm">
								<img name="FotoUtente" src="nofoto.jpg" id="fotoprofilo" class="flex">
								<input type="file" id="sourcefoto" width="100%" style="color: transparent; display: none;" accept=".jpg, .png, .jpeg">
							</div>
							<div class="col-sm" id="space_info">
								<div class="row">
									<span id="nprof"> <b id="cprof">Name</b> Surname</span>  
								</div>
								<div class="row">
									<h1 id="userprofil">Username</h1> 
								</div>
								<div class="row">
									<h1 id="numprof">555 555 555</h1>
								</div>
								<div class="row">
									<h1 id="eprof">Email</h1>
								</div>
							</div>
						</div>
						<div class="row" style="margin-top: 2%;">
							<div class="col-sm" id="modifica_foto">
								<button id="editbutton" class="btn btn-light btn-sm" onclick="document.getElementById('sourcefoto').click()">Edit</button>
							</div>
							<div class="col-sm" id="inviamodifica">
								<a href="edit.html" id="editinfo">Edit</a>
								<button type="submit" id="logout" class="btn btn-light; red-butt">Logout</button>
							</div>
						</div>
					</div>
	
					<div class="box-down-profile" > 
						
						<div class="box-down-left-profile" id="spazio_creati">
							<h1> Created</h1>
						</div>
						<div class="box-down-right-profile" id="spazio_aderiti">
							<h1> Subscribed </h1>
						</div>	
					</div>
				</div>
	
			</div>
	
			<div class="box-footer">
				<h3>@BeeTea inc.</h3>
			</div>

		</div>
		
		<script type="module">
				import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.3/firebase-app.js";
				import { getDatabase, set, ref, update , get, child,onValue ,onChildAdded, orderByChild,limitToLast} from "https://www.gstatic.com/firebasejs/9.6.3/firebase-database.js";
				import { getAuth, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.3/firebase-auth.js";
				import { getStorage, ref as storef, uploadBytesResumable,getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.3/firebase-storage.js";
				import { collection, query, where, getDoc,addDoc,getFirestore, updateDoc,arrayUnion,doc ,setDoc, increment} from "https://www.gstatic.com/firebasejs/9.6.3/firebase-firestore.js";

			// import * as func2 from "./js/func2.js";
			   import {att,att2,att_sub,att_richiesta,getElem,createButton,getUser,sign_Out} from "./js/functions.js";

				const firebaseConfig = {
				apiKey: "AIzaSyA0PdI6RRM_VqyxEsUYuPe0Gu_TUrbbuuQ",
				authDomain: "beeteam-2a5f7.firebaseapp.com",
				databaseURL: "https://beeteam-2a5f7-default-rtdb.firebaseio.com",
				projectId: "beeteam-2a5f7",
				storageBucket: "beeteam-2a5f7.appspot.com",
				messagingSenderId: "223479016271",
				appId: "1:223479016271:web:383e9319470cfaf4bd733a",
				measurementId: "G-04ERX78GQJ"
				};
			
				// Initialize Firebase
			export const app= initializeApp(firebaseConfig);
			export const database = getDatabase(app);
			const fire=getFirestore(app);

			let nprof=document.getElementById("nprof");
			let cprof=document.getElementById("cprof");
			let userprof=document.getElementById("userprofil");
			let numprof=document.getElementById("numprof");
			let eprof=document.getElementById("eprof");
			let foto=document.getElementById("fotoprofilo");

			let inviamodifica=document.getElementById("inviamodifica");
			let modifica_foto=document.getElementById("modifica_foto");
			let space_info=document.getElementById("space_info");


			const out=document.getElementById("logout");
			const edit=document.getElementById("editbutton");
			const sub=document.getElementById("subedit");
			const info=document.getElementById("editinfo")
			var percorso=null;
			var up=null;
			
			var storage=getStorage(app);

			var CurrentUser=null;

			var btnsub=null,c2=null,n2=null, num2=null,p2, edit_pass;

			function openEdit(){
				window.location="edit.html";
			}
	
			function editPhoto(){
				btnsub=document.createElement("button");
				btnsub.setAttribute("type","submit");
				btnsub.setAttribute("class","btn btn-light btn-sm");
				btnsub.innerHTML="Save";

				modifica_foto.replaceChild(btnsub,edit);
				btnsub.addEventListener('click',function(){updatePhoto(btnsub)});
			}


			function updatePhoto(btn){
				const f=document.getElementById("sourcefoto").files[0];
				
				const metadata = {
					contentType: 'image/'+f.type,
				};
				
				var storageRef= storef(storage, "FotoProfilo/"+ CurrentUser.user);
				var uploadTask= uploadBytesResumable(storageRef,f,metadata)
					alert("Update Succesfully");
			

				getDownloadURL(uploadTask.snapshot.ref).then((url) => {
				console.log('File available at', url);
				const xhr = new XMLHttpRequest();
				xhr.responseType = 'blob';
				xhr.onload = (event) => {
					const blob = xhr.response;
				};
				xhr.open('GET', url);
				xhr.send();
				foto.setAttribute("src",url);
				update(ref(database, "Users/"+CurrentUser.uid),{
							foto:url,
				});
				})
				.catch((error)=>{
					alert(error);
				})

				modifica_foto.replaceChild(edit,btn);
				saveData(CurrentUser.uid);

			};

			out.addEventListener('click',sign_Out);
			info.addEventListener('click',openEdit);
			edit.addEventListener('click',editPhoto);

			let spazio_post=null;
			const date2= new Date();

			const commentsRef = query(ref(database, "Attivity"),orderByChild('data'));

            onChildAdded(commentsRef, (date) => {
                let c=null;
                let dati_utente=date.val();
				const docRef = doc(fire, "post",date.key);
				const docSnap =  getDoc(docRef).then((item) =>{
				const items=item.data();
				if(items.creator==CurrentUser.user) {
					spazio_post=document.getElementById("spazio_creati");
					if(items.sub_restanti!=0) att2(date.key, spazio_post, c ,dati_utente.type, dati_utente.member, dati_utente.description, items.sub_restanti);
					else att_richiesta(date.key, spazio_post, c ,dati_utente.type, dati_utente.member, dati_utente.description, items.sub_restanti);
				}
				else if(items.sub.includes(CurrentUser.email)){
					spazio_post=document.getElementById("spazio_aderiti");
					att_sub(date.key, spazio_post, c ,dati_utente.type, dati_utente.member, dati_utente.anonymous,dati_utente.description, dati_utente.user,items.sub_restanti );
				}
			}
            );
			});
			
			window.onload=function() {
				CurrentUser=getUser();
				if(CurrentUser==null){
					alert("Non hai effettuato l'accesso!");
					window.location="404.html";

				}
				else{
					nprof.innerText= CurrentUser.nome +" "+ CurrentUser.cognome;
					nprof.style="color: white";
					userprof.innerText= CurrentUser.user;
					userprof.style="color: white";
					numprof.innerText= CurrentUser.numero;
					numprof.style="color: white";
					eprof.innerText= CurrentUser.email;
					eprof.style="color: white";
					if(CurrentUser.foto!=null) foto.setAttribute("src",CurrentUser.foto);
					else foto.setAttribute("src","nofoto.jpg");
					

				}
			}

				

				
			
		
	</script>
</body>
</html>
